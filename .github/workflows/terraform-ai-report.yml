name: ğŸ¤– AI-Assisted Preview Deployment

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-deploy:
    name: AI Deploy (${{ github.event.comment.id }})
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'deploy-preview')
    concurrency:
      group: ai-deploy-${{ github.event.comment.id }}
    env:
      GITHUB_COMMENT: ${{ github.event.comment.body }}

    steps:
      - name: ğŸ§° Install Dependencies
        run: |
          pip install openai

      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  Generate Deployment Commands with GPT-5
        id: ai_generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 <<'EOF'
          import os
          import re
          from openai import OpenAI

          comment = os.getenv("GITHUB_COMMENT", "/deploy-preview feature-x")
          dry_run = "dry-run" in comment.lower()

          prompt = f"""
          You are a DevOps AI assistant.
          The user comment is: "{comment}"

          Generate ONLY shell commands (no explanations) that safely deploy
          a Kubernetes preview environment using manifests under ./k8s.
          Use kubectl apply -f or kubectl create commands only.

          Output MUST be plain bash commands (no markdown, no interpretation, no text).
          """

          client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
          response = client.chat.completions.create(
              model="gpt-5",
              messages=[{"role": "user", "content": prompt}]
          )

          cmds = response.choices[0].message.content.strip()
          cmds = re.sub(r'(?i)`+|```+|interpretation.*|^#.*', '', cmds)
          cmds = re.sub(r'[^a-zA-Z0-9_\\-\\.\\$/ \\n=:~"{}]+', '', cmds)

          with open("commands.sh", "w") as f:
              f.write(cmds + "\\n")

          with open("dryrun.txt", "w") as f:
              f.write(("DRY RUN MODE\\n" if dry_run else "EXECUTION MODE\\n") + cmds)
          EOF

      - name: ğŸš€ Execute AI-Generated Commands
        if: "!contains(github.event.comment.body, 'dry-run')"
        run: |
          echo "Running AI-generated commands..."
          chmod +x commands.sh
          cat commands.sh
          bash commands.sh || echo "âš ï¸ Some commands may have failed. Please check logs."

      - name: ğŸ§¾ Capture Commands Output
        id: show_cmds
        shell: bash
        run: |
          delimiter=$(uuidgen)
          {
            echo "commands<<${delimiter}"
            cat commands.sh || echo "âš ï¸ commands.sh not found"
            echo "${delimiter}"
          } >> "$GITHUB_OUTPUT"

      - name: ğŸ§¾ Capture Logs Output
        id: show_logs
        shell: bash
        run: |
          delimiter=$(uuidgen)
          {
            echo "logs<<${delimiter}"
            cat dryrun.txt || echo "âš ï¸ dryrun.txt not found"
            echo "${delimiter}"
          } >> "$GITHUB_OUTPUT"

      - name: ğŸ—¨ï¸ Post AI Deployment Summary on PR
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'issue_comment'
        with:
          header: "ğŸ¤– AI-Assisted Deploy Preview"
          message: |
            ## ğŸ¤– AI-Assisted Deployment Summary

            **Comment:** `${{ github.event.comment.body }}`  
            **Mode:** ${{ contains(github.event.comment.body, 'dry-run') && 'ğŸ§ª Dry Run' || 'ğŸš€ Execution' }}

            **Generated Commands:**
            ```bash
            ${{ steps.show_cmds.outputs.commands }}
            ```

            **AI Action Log:**
            ```
            ${{ steps.show_logs.outputs.logs }}
            ```

            ğŸ“ *AI-generated commands were executed (or simulated if dry-run).*
